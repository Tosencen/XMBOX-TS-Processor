name: XMBOX TSå¤„ç†å™¨

on:
  repository_dispatch:
    types: [process_ts]

env:
  TASK_DIR: tasks
  OUTPUT_DIR: output

jobs:
  process-ts:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        ref: master
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: è®¾ç½® FFmpeg
      uses: FedericoCarboni/setup-ffmpeg@v3
      with:
        ffmpeg-version: release
        architecture: x64
    
    - name: éªŒè¯ FFmpeg å®‰è£…
      run: |
        echo "ğŸ”§ éªŒè¯FFmpegå®‰è£…..."
        ffmpeg -version | head -5
        echo ""
        echo "ğŸ“‹ æ”¯æŒçš„æ ¼å¼:"
        ffmpeg -formats | grep -E "(mpegts|mp4)" | head -10
        echo ""
        echo "âœ… FFmpegå‡†å¤‡å°±ç»ª"
    
    - name: å‡†å¤‡å·¥ä½œç›®å½•
      run: |
        TASK_ID="${{ github.event.client_payload.task_id }}"
        mkdir -p "$TASK_DIR/$TASK_ID"
        mkdir -p "$OUTPUT_DIR"
        echo "TASK_ID=$TASK_ID" >> $GITHUB_ENV
    
    - name: å¤„ç†TSæ–‡ä»¶
      run: |
        cd "$TASK_DIR/$TASK_ID"
        
        # éªŒè¯TSæ–‡ä»¶
        echo "ğŸ” éªŒè¯TSæ–‡ä»¶..."
        total_files=$(ls -1 *.ts 2>/dev/null | wc -l)
        if [ "$total_files" -eq 0 ]; then
          echo "âŒ é”™è¯¯ï¼šæ²¡æœ‰æ‰¾åˆ°TSæ–‡ä»¶"
          exit 1
        fi
        echo "âœ… å‘ç° $total_files ä¸ªTSæ–‡ä»¶"
        
        # å‡†å¤‡è¾“å‡ºç›®å½•
        FINAL_OUTPUT="../../$OUTPUT_DIR/${TASK_ID}.mp4"
        mkdir -p "$(dirname "$FINAL_OUTPUT")"
        
        # éªŒè¯æ¯ä¸ªTSæ–‡ä»¶å¹¶è¾“å‡ºè°ƒè¯•ä¿¡æ¯
        echo "ï¿½ éªŒè¯å•ä¸ªæ–‡ä»¶..."
        for f in $(ls -1v *.ts); do
          echo "æ£€æŸ¥æ–‡ä»¶: $f"
          ffprobe -v warning "$f" 2>&1 || {
            echo "âŒ é”™è¯¯ï¼šæ–‡ä»¶ $f éªŒè¯å¤±è´¥"
            exit 1
          }
        done
        
        echo "ğŸ“ ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨..."
        rm -f files.txt
        for f in $(ls -1v *.ts); do
          echo "file '$(pwd)/$f'" >> files.txt
        done
        
        echo "ğŸ“„ æ–‡ä»¶åˆ—è¡¨å†…å®¹:"
        cat files.txt
        
        # ä½¿ç”¨FFmpegåˆå¹¶ï¼ˆå¯ç”¨è¯¦ç»†æ—¥å¿—ï¼‰
        echo "ğŸ¬ å¼€å§‹åˆå¹¶..."
        if ! ffmpeg -v warning -f concat -safe 0 -i files.txt -c copy "$FINAL_OUTPUT" 2>&1; then
          echo "âŒ é”™è¯¯ï¼šåˆå¹¶å¤±è´¥"
          rm -f "$FINAL_OUTPUT"
          exit 1
        fi
        
        # éªŒè¯è¾“å‡ºæ–‡ä»¶
        echo "ğŸ” éªŒè¯è¾“å‡ºæ–‡ä»¶..."
        if ! ffprobe -v warning "$FINAL_OUTPUT" 2>&1; then
          echo "âŒ é”™è¯¯ï¼šè¾“å‡ºæ–‡ä»¶éªŒè¯å¤±è´¥"
          rm -f "$FINAL_OUTPUT"
          exit 1
        fi
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°
        output_size=$(stat -f %z "$FINAL_OUTPUT" || stat -c %s "$FINAL_OUTPUT")
        echo "ğŸ“Š è¾“å‡ºæ–‡ä»¶å¤§å°: $output_size å­—èŠ‚"
        
        if [ "$output_size" -lt 1024 ]; then
          echo "âŒ é”™è¯¯ï¼šè¾“å‡ºæ–‡ä»¶å¤ªå°ï¼Œå¯èƒ½æœªæ­£ç¡®åˆå¹¶"
          rm -f "$FINAL_OUTPUT"
          exit 1
        fi
        
        echo "âœ… å¤„ç†å®Œæˆï¼š$(basename "$FINAL_OUTPUT")"
    
    - name: åˆ›å»ºå‘å¸ƒ
      uses: softprops/action-gh-release@v1
      with:
        tag_name: task-${{ env.TASK_ID }}
        name: "TSå¤„ç†ç»“æœ - ${{ github.event.client_payload.title }}"
        body: |
          ğŸ¥ å¤„ç†ä»»åŠ¡ID: ${{ env.TASK_ID }}
          ğŸ“ è§†é¢‘æ ‡é¢˜: ${{ github.event.client_payload.title }}
          ğŸ“Š å¤„ç†æ–‡ä»¶æ•°: ${{ github.event.client_payload.file_count }}
          â± å¤„ç†æ—¶é—´: ${{ github.event.created_at }}
        files: |
          ${{ env.OUTPUT_DIR }}/${{ env.TASK_ID }}.mp4
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}