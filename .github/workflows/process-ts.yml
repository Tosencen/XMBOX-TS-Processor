name: XMBOX TS处理器

on:
  repository_dispatch:
    types: [process_ts]

env:
  TASK_DIR: tasks
  OUTPUT_DIR: output

jobs:
  process-ts:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        ref: master
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: 设置 FFmpeg
      uses: FedericoCarboni/setup-ffmpeg@v3
      with:
        ffmpeg-version: release
        architecture: x64
    
    - name: 验证 FFmpeg 安装
      run: |
        echo "🔧 验证FFmpeg安装..."
        ffmpeg -version | head -5
        echo ""
        echo "📋 支持的格式:"
        ffmpeg -formats | grep -E "(mpegts|mp4)" | head -10
        echo ""
        echo "✅ FFmpeg准备就绪"
    
    - name: 准备工作目录
      run: |
        TASK_ID="${{ github.event.client_payload.task_id }}"
        mkdir -p "$TASK_DIR/$TASK_ID"
        mkdir -p "$OUTPUT_DIR"
        echo "TASK_ID=$TASK_ID" >> $GITHUB_ENV
    
    - name: 处理TS文件
      run: |
        cd "$TASK_DIR/$TASK_ID"
        
        # 验证TS文件
        echo "🔍 验证TS文件..."
        total_files=$(ls -1 *.ts 2>/dev/null | wc -l)
        if [ "$total_files" -eq 0 ]; then
          echo "❌ 错误：没有找到TS文件"
          exit 1
        fi
        echo "✅ 发现 $total_files 个TS文件"
        
        # 准备输出目录
        FINAL_OUTPUT="../../$OUTPUT_DIR/${TASK_ID}.mp4"
        mkdir -p "$(dirname "$FINAL_OUTPUT")"
        
        # 验证每个TS文件并输出调试信息
        echo "� 验证单个文件..."
        for f in $(ls -1v *.ts); do
          echo "检查文件: $f"
          ffprobe -v warning "$f" 2>&1 || {
            echo "❌ 错误：文件 $f 验证失败"
            exit 1
          }
        done
        
        echo "📝 生成文件列表..."
        rm -f files.txt
        for f in $(ls -1v *.ts); do
          echo "file '$(pwd)/$f'" >> files.txt
        done
        
        echo "📄 文件列表内容:"
        cat files.txt
        
        # 使用FFmpeg合并（启用详细日志）
        echo "🎬 开始合并..."
        if ! ffmpeg -v warning -f concat -safe 0 -i files.txt -c copy "$FINAL_OUTPUT" 2>&1; then
          echo "❌ 错误：合并失败"
          rm -f "$FINAL_OUTPUT"
          exit 1
        fi
        
        # 验证输出文件
        echo "🔍 验证输出文件..."
        if ! ffprobe -v warning "$FINAL_OUTPUT" 2>&1; then
          echo "❌ 错误：输出文件验证失败"
          rm -f "$FINAL_OUTPUT"
          exit 1
        fi
        
        # 检查文件大小
        output_size=$(stat -f %z "$FINAL_OUTPUT" || stat -c %s "$FINAL_OUTPUT")
        echo "📊 输出文件大小: $output_size 字节"
        
        if [ "$output_size" -lt 1024 ]; then
          echo "❌ 错误：输出文件太小，可能未正确合并"
          rm -f "$FINAL_OUTPUT"
          exit 1
        fi
        
        echo "✅ 处理完成：$(basename "$FINAL_OUTPUT")"
    
    - name: 创建发布
      uses: softprops/action-gh-release@v1
      with:
        tag_name: task-${{ env.TASK_ID }}
        name: "TS处理结果 - ${{ github.event.client_payload.title }}"
        body: |
          🎥 处理任务ID: ${{ env.TASK_ID }}
          📝 视频标题: ${{ github.event.client_payload.title }}
          📊 处理文件数: ${{ github.event.client_payload.file_count }}
          ⏱ 处理时间: ${{ github.event.created_at }}
        files: |
          ${{ env.OUTPUT_DIR }}/${{ env.TASK_ID }}.mp4
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}