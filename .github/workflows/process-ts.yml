name: XMBOX TSå¤„ç†å™¨name: XMBOX TSå¤„ç†å™¨name: XMBOX TSå¤„ç†å™¨



on:

  repository_dispatch:

    types: [process_ts]on:on:



env:  repository_dispatch:  repository_dispatch:

  TASK_DIR: tasks

  OUTPUT_DIR: output    types: [process_ts]    types: [process_ts]



jobs:

  process-ts:

    runs-on: ubuntu-latestenv:env:

    permissions:

      contents: write  TASK_DIR: tasks  TASK_DIR: tasks

      

    steps:  OUTPUT_DIR: output  OUTPUT_DIR: output

    - name: æ£€å‡ºä»£ç 

      uses: actions/checkout@v4

      with:

        ref: masterjobs:jobs:

        token: ${{ secrets.GITHUB_TOKEN }}

      process-ts:  process-ts:

    - name: è®¾ç½® FFmpeg

      uses: FedericoCarboni/setup-ffmpeg@v3    runs-on: ubuntu-latest    runs-on: ubuntu-latest

      id: setup-ffmpeg

      with:    permissions:    permissions:

        ffmpeg-version: release

        architecture: x64      contents: write      contents: write

    

    - name: éªŒè¯ FFmpeg å®‰è£…            

      run: |

        echo "ğŸ”§ éªŒè¯FFmpegå®‰è£…..."    steps:    steps:

        ffmpeg -version | head -5

        echo ""    - name: æ£€å‡ºä»£ç     - name: æ£€å‡ºä»£ç 

        echo "ğŸ“‹ æ”¯æŒçš„æ ¼å¼:"

        ffmpeg -formats | grep -E "(mpegts|mp4)" | head -10      uses: actions/checkout@v4      uses: actions/checkout@v4

        echo ""

        echo "âœ… FFmpegå‡†å¤‡å°±ç»ª"      with:      with:

    

    - name: å‡†å¤‡å·¥ä½œç›®å½•        ref: master        ref: master

      run: |

        TASK_ID="${{ github.event.client_payload.task_id }}"        token: ${{ secrets.GITHUB_TOKEN }}        token: ${{ secrets.GITHUB_TOKEN }}

        mkdir -p "$TASK_DIR/$TASK_ID"

        mkdir -p "$OUTPUT_DIR"        

        echo "TASK_ID=$TASK_ID" >> $GITHUB_ENV

        - name: è®¾ç½® FFmpeg    - name: è®¾ç½® FFmpeg

    - name: å¤„ç†TSæ–‡ä»¶

      run: |      uses: FedericoCarboni/setup-ffmpeg@v3      uses: FedericoCarboni/setup-ffmpeg@v3

        cd "$TASK_DIR/$TASK_ID"

              with:      with:

        # éªŒè¯TSæ–‡ä»¶

        echo "ğŸ” éªŒè¯TSæ–‡ä»¶..."        ffmpeg-version: release        ffmpeg-version: release

        total_files=$(ls -1 *.ts 2>/dev/null | wc -l)

        if [ "$total_files" -eq 0 ]; then        architecture: x64        architecture: x64

          echo "âŒ é”™è¯¯ï¼šæ²¡æœ‰æ‰¾åˆ°TSæ–‡ä»¶"

          exit 1        

        fi

        echo "âœ… å‘ç° $total_files ä¸ªTSæ–‡ä»¶"    - name: éªŒè¯ FFmpeg å®‰è£…    - name: éªŒè¯ FFmpeg å®‰è£…

        

        # å‡†å¤‡è¾“å‡ºç›®å½•      run: |      run: |

        FINAL_OUTPUT="../../$OUTPUT_DIR/${TASK_ID}.mp4"

        TEMP_TS="../../$OUTPUT_DIR/${TASK_ID}_temp.ts"        echo "ğŸ”§ éªŒè¯FFmpegå®‰è£…..."        echo "ğŸ”§ éªŒè¯FFmpegå®‰è£…..."

        mkdir -p "$(dirname "$FINAL_OUTPUT")"

                ffmpeg -version | head -5        ffmpeg -version | head -5

        # ç®€å•äºŒè¿›åˆ¶åˆå¹¶

        echo "ğŸ”„ ä½¿ç”¨äºŒè¿›åˆ¶åˆå¹¶..."        echo ""        echo ""

        if ! cat $(ls -1v *.ts) > "$TEMP_TS"; then

          echo "âŒ é”™è¯¯ï¼šåˆå¹¶å¤±è´¥"        echo "ğŸ“‹ æ”¯æŒçš„æ ¼å¼:"        echo "ğŸ“‹ æ”¯æŒçš„æ ¼å¼:"

          rm -f "$TEMP_TS"

          exit 1        ffmpeg -formats | grep -E "(mpegts|mp4)" | head -10        ffmpeg -formats | grep -E "(mpegts|mp4)" | head -10

        fi

                echo ""        echo ""

        # è½¬æ¢ä¸ºMP4

        echo "ğŸ¬ è½¬æ¢ä¸ºMP4..."        echo "âœ… FFmpegå‡†å¤‡å°±ç»ª"        echo "âœ… FFmpegå‡†å¤‡å°±ç»ª"

        if ! ffmpeg -v error -fflags +igndts -i "$TEMP_TS" -c copy -movflags +faststart "$FINAL_OUTPUT"; then

          echo "âŒ é”™è¯¯ï¼šè½¬æ¢å¤±è´¥"        

          rm -f "$TEMP_TS" "$FINAL_OUTPUT"

          exit 1    - name: å‡†å¤‡å·¥ä½œç›®å½•    - name: å‡†å¤‡å·¥ä½œç›®å½•

        fi

              run: |      run: |

        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶

        rm -f "$TEMP_TS"        TASK_ID="${{ github.event.client_payload.task_id }}"        TASK_ID="${{ github.event.client_payload.task_id }}"

        

        # éªŒè¯è¾“å‡º        mkdir -p "$TASK_DIR/$TASK_ID"        mkdir -p "$TASK_DIR/$TASK_ID"

        if [ ! -f "$FINAL_OUTPUT" ]; then

          echo "âŒ é”™è¯¯ï¼šè¾“å‡ºæ–‡ä»¶ä¸å­˜åœ¨"        mkdir -p "$OUTPUT_DIR"        mkdir -p "$OUTPUT_DIR"

          exit 1

        fi        echo "TASK_ID=$TASK_ID" >> $GITHUB_ENV        echo "TASK_ID=$TASK_ID" >> $GITHUB_ENV

        

        # æ£€æŸ¥æ–‡ä»¶å¤§å°        

        output_size=$(stat -f %z "$FINAL_OUTPUT" 2>/dev/null || stat -c %s "$FINAL_OUTPUT")

        echo "ğŸ“Š è¾“å‡ºæ–‡ä»¶å¤§å°: $output_size å­—èŠ‚"    - name: å¤„ç†TSæ–‡ä»¶    - name: å¤„ç†TSæ–‡ä»¶

        

        if [ "$output_size" -lt 1024 ]; then      run: |      run: |

          echo "âŒ é”™è¯¯ï¼šè¾“å‡ºæ–‡ä»¶å¤ªå°"

          rm -f "$FINAL_OUTPUT"        cd "$TASK_DIR/$TASK_ID"        cd "$TASK_DIR/$TASK_ID"

          exit 1

        fi                

        

        echo "âœ… å¤„ç†å®Œæˆï¼š$(basename "$FINAL_OUTPUT")"        # éªŒè¯TSæ–‡ä»¶        # éªŒè¯TSæ–‡ä»¶

    

    - name: åˆ›å»ºå‘å¸ƒ        echo "ğŸ” éªŒè¯TSæ–‡ä»¶..."        echo "ğŸ” éªŒè¯TSæ–‡ä»¶..."

      if: success()

      uses: softprops/action-gh-release@v1        total_files=$(ls -1 *.ts 2>/dev/null | wc -l)        total_files=$(ls -1 *.ts 2>/dev/null | wc -l)

      with:

        tag_name: task-${{ env.TASK_ID }}        if [ "$total_files" -eq 0 ]; then        if [ "$total_files" -eq 0 ]; then

        name: "è§†é¢‘ï¼š${{ github.event.client_payload.title }}"

        files: ${{ env.OUTPUT_DIR }}/${{ env.TASK_ID }}.mp4          echo "âŒ é”™è¯¯ï¼šæ²¡æœ‰æ‰¾åˆ°TSæ–‡ä»¶"          echo "âŒ é”™è¯¯ï¼šæ²¡æœ‰æ‰¾åˆ°TSæ–‡ä»¶"

        token: ${{ secrets.GITHUB_TOKEN }}
          exit 1          exit 1

        fi        fi

        echo "âœ… å‘ç° $total_files ä¸ªTSæ–‡ä»¶"        echo "âœ… å‘ç° $total_files ä¸ªTSæ–‡ä»¶"

                

        # å‡†å¤‡è¾“å‡ºç›®å½•å’Œä¸´æ—¶ç›®å½•        # å‡†å¤‡è¾“å‡ºç›®å½•

        FINAL_OUTPUT="../../$OUTPUT_DIR/${TASK_ID}.mp4"        FINAL_OUTPUT="../../$OUTPUT_DIR/${TASK_ID}.mp4"

        TEMP_TS="../../$OUTPUT_DIR/${TASK_ID}_temp.ts"        mkdir -p "$(dirname "$FINAL_OUTPUT")"

        mkdir -p "$(dirname "$FINAL_OUTPUT")"        

                # éªŒè¯æ¯ä¸ªTSæ–‡ä»¶å¹¶è¾“å‡ºè°ƒè¯•ä¿¡æ¯

        # æ£€æŸ¥æ¯ä¸ªæ–‡ä»¶çš„åŸºæœ¬å®Œæ•´æ€§        echo "ï¿½ éªŒè¯å•ä¸ªæ–‡ä»¶..."

        echo "ğŸ” æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§..."        for f in $(ls -1v *.ts); do

        for f in *.ts; do          echo "æ£€æŸ¥æ–‡ä»¶: $f"

          if [ ! -s "$f" ]; then          ffprobe -v warning "$f" 2>&1 || {

            echo "âŒ é”™è¯¯ï¼šæ–‡ä»¶ $f æ˜¯ç©ºæ–‡ä»¶"            echo "âŒ é”™è¯¯ï¼šæ–‡ä»¶ $f éªŒè¯å¤±è´¥"

            exit 1            exit 1

          fi          }

        done        done

                

        # å°è¯•æ–¹æ³•1: ç®€å•äºŒè¿›åˆ¶åˆå¹¶        echo "ğŸ“ ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨..."

        echo "ğŸ”„ å°è¯•æ–¹æ³•1: äºŒè¿›åˆ¶åˆå¹¶..."        rm -f files.txt

        if cat $(ls -1v *.ts) > "$TEMP_TS" 2>/dev/null; then        for f in $(ls -1v *.ts); do

          if ffmpeg -v error -i "$TEMP_TS" -c copy -y "$FINAL_OUTPUT" 2>/dev/null; then          echo "file '$(pwd)/$f'" >> files.txt

            echo "âœ… æ–¹æ³•1æˆåŠŸ"        done

            rm -f "$TEMP_TS"        

            exit 0        echo "ğŸ“„ æ–‡ä»¶åˆ—è¡¨å†…å®¹:"

          fi        cat files.txt

          rm -f "$TEMP_TS" "$FINAL_OUTPUT"        

        fi        # ä½¿ç”¨FFmpegåˆå¹¶ï¼ˆå¯ç”¨è¯¦ç»†æ—¥å¿—ï¼‰

                echo "ğŸ¬ å¼€å§‹åˆå¹¶..."

        # æ–¹æ³•2: ä½¿ç”¨concat demuxer        if ! ffmpeg -v warning -f concat -safe 0 -i files.txt -c copy "$FINAL_OUTPUT" 2>&1; then

        echo "ğŸ”„ å°è¯•æ–¹æ³•2: concat demuxer..."          echo "âŒ é”™è¯¯ï¼šåˆå¹¶å¤±è´¥"

        echo > files.txt          rm -f "$FINAL_OUTPUT"

        for f in $(ls -1v *.ts); do          exit 1

          echo "file '$f'" >> files.txt        fi

        done        

                # éªŒè¯è¾“å‡ºæ–‡ä»¶

        if ffmpeg -v error -f concat -safe 0 -i files.txt -c copy -y "$FINAL_OUTPUT" 2>/dev/null; then        echo "ğŸ” éªŒè¯è¾“å‡ºæ–‡ä»¶..."

          echo "âœ… æ–¹æ³•2æˆåŠŸ"        if ! ffprobe -v warning "$FINAL_OUTPUT" 2>&1; then

          rm -f files.txt          echo "âŒ é”™è¯¯ï¼šè¾“å‡ºæ–‡ä»¶éªŒè¯å¤±è´¥"

          exit 0          rm -f "$FINAL_OUTPUT"

        fi          exit 1

        rm -f files.txt "$FINAL_OUTPUT"        fi

                

        # æ–¹æ³•3: ä½¿ç”¨concat protocol        # æ£€æŸ¥æ–‡ä»¶å¤§å°

        echo "ğŸ”„ å°è¯•æ–¹æ³•3: concat protocol..."        output_size=$(stat -f %z "$FINAL_OUTPUT" || stat -c %s "$FINAL_OUTPUT")

        input_files=""        echo "ğŸ“Š è¾“å‡ºæ–‡ä»¶å¤§å°: $output_size å­—èŠ‚"

        for f in $(ls -1v *.ts); do        

          [ -n "$input_files" ] && input_files="$input_files|"        if [ "$output_size" -lt 1024 ]; then

          input_files="${input_files}${f}"          echo "âŒ é”™è¯¯ï¼šè¾“å‡ºæ–‡ä»¶å¤ªå°ï¼Œå¯èƒ½æœªæ­£ç¡®åˆå¹¶"

        done          rm -f "$FINAL_OUTPUT"

                  exit 1

        if ffmpeg -v error -i "concat:$input_files" -c copy -y "$FINAL_OUTPUT" 2>/dev/null; then        fi

          echo "âœ… æ–¹æ³•3æˆåŠŸ"        

          exit 0        echo "âœ… å¤„ç†å®Œæˆï¼š$(basename "$FINAL_OUTPUT")"

        fi    

        rm -f "$FINAL_OUTPUT"    - name: åˆ›å»ºå‘å¸ƒ

              uses: softprops/action-gh-release@v1

        # æ–¹æ³•4: ä½¿ç”¨segment muxer      with:

        echo "ğŸ”„ å°è¯•æ–¹æ³•4: segment muxer..."        tag_name: task-${{ env.TASK_ID }}

        if ffmpeg -v error -i "$(ls -1v *.ts | head -1)" -f segment -segment_list files.txt -c copy segments%03d.ts && \        name: "TSå¤„ç†ç»“æœ - ${{ github.event.client_payload.title }}"

           ffmpeg -v error -f concat -safe 0 -i files.txt -c copy -y "$FINAL_OUTPUT" 2>/dev/null; then        body: |

          echo "âœ… æ–¹æ³•4æˆåŠŸ"          ğŸ¥ å¤„ç†ä»»åŠ¡ID: ${{ env.TASK_ID }}

          rm -f segments*.ts files.txt          ğŸ“ è§†é¢‘æ ‡é¢˜: ${{ github.event.client_payload.title }}

          exit 0          ğŸ“Š å¤„ç†æ–‡ä»¶æ•°: ${{ github.event.client_payload.file_count }}

        fi          â± å¤„ç†æ—¶é—´: ${{ github.event.created_at }}

        rm -f segments*.ts files.txt "$FINAL_OUTPUT"        files: |

                  ${{ env.OUTPUT_DIR }}/${{ env.TASK_ID }}.mp4

        # æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥      env:

        echo "âŒ é”™è¯¯ï¼šæ‰€æœ‰åˆå¹¶æ–¹æ³•éƒ½å¤±è´¥äº†"        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        exit 1
    
    - name: åˆ›å»ºå‘å¸ƒ
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: task-${{ env.TASK_ID }}
        name: "è§†é¢‘ï¼š${{ github.event.client_payload.title }}"
        files: ${{ env.OUTPUT_DIR }}/${{ env.TASK_ID }}.mp4
        token: ${{ secrets.GITHUB_TOKEN }}