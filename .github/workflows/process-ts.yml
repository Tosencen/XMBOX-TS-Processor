# GitHub Actionså·¥ä½œæµ: XMBOX TSç‰‡æ®µåˆæˆå¤„ç†
# ä»“åº“: https://github.com/Tosencen/XMBOX-TS-Processor
# ç”¨é€”: ä¸ºXMBOXåº”ç”¨æä¾›äº‘ç«¯TSåˆå¹¶æœåŠ¡

name: XMBOX TS Processing

on:
  workflow_dispatch:
    inputs:
      task_id:
        description: 'ä»»åŠ¡ID'
        required: true
        type: string
      file_count:
        description: 'TSæ–‡ä»¶æ•°é‡'
        required: true
        type: number
      title:
        description: 'è§†é¢‘æ ‡é¢˜'
        required: true
        type: string

jobs:
  process-ts:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: processing
    
    - name: Setup FFmpeg
      uses: FedericoCarboni/setup-ffmpeg@v3
      with:
        ffmpeg-version: release
        architecture: x64
    
    - name: Verify FFmpeg installation
      run: |
        echo "ðŸ”§ éªŒè¯FFmpegå®‰è£…..."
        ffmpeg -version | head -5
        echo ""
        echo "ðŸ“‹ æ”¯æŒçš„æ ¼å¼:"
        ffmpeg -formats | grep -E "(mpegts|mp4)" | head -10
        echo ""
        echo "âœ… FFmpegå‡†å¤‡å°±ç»ª"
    
    - name: Process TS segments
      env:
        TASK_ID: ${{ github.event.inputs.task_id }}
        FILE_COUNT: ${{ github.event.inputs.file_count }}
        TITLE: ${{ github.event.inputs.title }}
      run: |
        echo "ðŸŽ¬ å¼€å§‹å¤„ç†XMBOX TSåˆå¹¶ä»»åŠ¡"
        echo "ðŸ“ ä»»åŠ¡ID: $TASK_ID"
        echo "ðŸ“Š æ–‡ä»¶æ•°é‡: $FILE_COUNT"
        echo "ðŸŽ¯ è§†é¢‘æ ‡é¢˜: $TITLE"
        echo ""
        
        # è¿›å…¥ä»»åŠ¡ç›®å½•
        cd tasks/$TASK_ID
        
        # éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
        echo "ðŸ” éªŒè¯TSæ–‡ä»¶å®Œæ•´æ€§..."
        total_size=0
        for i in $(seq -f "%03g" 0 $((FILE_COUNT-1))); do
          if [ ! -f "segment_${i}.ts" ]; then
            echo "âŒ é”™è¯¯: æ–‡ä»¶ segment_${i}.ts ä¸å­˜åœ¨"
            exit 1
          fi
          file_size=$(du -b "segment_${i}.ts" | cut -f1)
          total_size=$((total_size + file_size))
          echo "âœ… segment_${i}.ts ($(du -h segment_${i}.ts | cut -f1))"
        done
        
        echo "ðŸ“¦ æ€»æ–‡ä»¶å¤§å°: $(numfmt --to=iec $total_size)"
        
        # éªŒè¯æ–‡ä»¶åˆ—è¡¨
        if [ ! -f "filelist.txt" ]; then
          echo "âŒ é”™è¯¯: filelist.txt ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo ""
        echo "ðŸ“‹ æ–‡ä»¶åˆ—è¡¨å†…å®¹:"
        cat filelist.txt
        echo ""
        
        # ä½¿ç”¨FFmpegåˆå¹¶TSç‰‡æ®µ
        echo "ðŸš€ å¼€å§‹FFmpegå¤„ç†..."
        echo "âš™ï¸  ä½¿ç”¨å‚æ•°: -c copy -avoid_negative_ts make_zero -fflags +genpts"
        
        ffmpeg -f concat -safe 0 -i filelist.txt \
               -c copy \
               -avoid_negative_ts make_zero \
               -fflags +genpts \
               -y output.mp4 \
               -v info
        
        # éªŒè¯è¾“å‡ºæ–‡ä»¶
        if [ ! -f "output.mp4" ]; then
          echo "âŒ é”™è¯¯: è¾“å‡ºæ–‡ä»¶æœªç”Ÿæˆ"
          exit 1
        fi
        
        # èŽ·å–æ–‡ä»¶ä¿¡æ¯
        OUTPUT_SIZE=$(du -h output.mp4 | cut -f1)
        DURATION=$(ffprobe -v quiet -show_entries format=duration -of csv=p=0 output.mp4 2>/dev/null || echo "æœªçŸ¥")
        
        echo ""
        echo "ðŸŽ‰ å¤„ç†å®Œæˆ!"
        echo "ðŸ“ è¾“å‡ºæ–‡ä»¶: output.mp4"
        echo "ðŸ“ æ–‡ä»¶å¤§å°: $OUTPUT_SIZE" 
        echo "â±ï¸  è§†é¢‘æ—¶é•¿: ${DURATION}ç§’"
        
        # é‡å‘½åä¸ºæœ€ç»ˆæ–‡ä»¶å
        final_name="${TASK_ID}.mp4"
        mv output.mp4 "$final_name"
        
        echo "âœ… æ–‡ä»¶å·²é‡å‘½åä¸º: $final_name"
        
        # ç”Ÿæˆå¤„ç†æŠ¥å‘Š
        cat > processing_report.txt << EOF
XMBOX TSå¤„ç†æŠ¥å‘Š
================
ä»»åŠ¡ID: $TASK_ID
è§†é¢‘æ ‡é¢˜: $TITLE
å¤„ç†æ—¶é—´: $(date)
TSæ–‡ä»¶æ•°é‡: $FILE_COUNT
è¾“å…¥æ€»å¤§å°: $(numfmt --to=iec $total_size)
è¾“å‡ºæ–‡ä»¶: $final_name
è¾“å‡ºå¤§å°: $OUTPUT_SIZE
è§†é¢‘æ—¶é•¿: ${DURATION}ç§’
å¤„ç†çŠ¶æ€: æˆåŠŸ
EOF
        
        echo ""
        echo "ðŸ“„ å¤„ç†æŠ¥å‘Š:"
        cat processing_report.txt
    
    - name: Upload result to release
      env:
        TASK_ID: ${{ github.event.inputs.task_id }}
        TITLE: ${{ github.event.inputs.title }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd tasks/$TASK_ID
        
        echo "ðŸ“¤ ä¸Šä¼ å¤„ç†ç»“æžœåˆ°GitHub Release..."
        
        # åˆ›å»ºRelease
        gh release create $TASK_ID \
          --title "XMBOX TSå¤„ç†ç»“æžœ: $TITLE" \
          --notes "ðŸŽ¬ **XMBOX TSç‰‡æ®µåˆæˆå®Œæˆ**
        
        ðŸ“Š **å¤„ç†ä¿¡æ¯:**
        - ä»»åŠ¡ID: \`$TASK_ID\`
        - è§†é¢‘æ ‡é¢˜: \`$TITLE\`
        - TSæ–‡ä»¶æ•°é‡: \`${{ github.event.inputs.file_count }}\`
        - è¾“å‡ºæ–‡ä»¶: \`${TASK_ID}.mp4\`
        - å¤„ç†æ—¶é—´: \`$(date)\`
        
        ðŸ“¥ **ä¸‹è½½é“¾æŽ¥:**
        ç‚¹å‡»ä¸‹æ–¹çš„ \`${TASK_ID}.mp4\` æ–‡ä»¶è¿›è¡Œä¸‹è½½
        
        âš ï¸ **æ³¨æ„:** æ­¤æ–‡ä»¶å°†åœ¨24å°æ—¶åŽè‡ªåŠ¨åˆ é™¤
        
        ðŸ”— **ç›¸å…³é“¾æŽ¥:**
        - [XMBOXé¡¹ç›®](https://github.com/Tosencen/XMBOX)
        - [å¤„ç†æ—¥å¿—](https://github.com/Tosencen/XMBOX-TS-Processor/actions/runs/${{ github.run_id }})" \
          ${TASK_ID}.mp4 processing_report.txt
        
        echo "âœ… Releaseåˆ›å»ºæˆåŠŸ: https://github.com/Tosencen/XMBOX-TS-Processor/releases/tag/$TASK_ID"
    
    - name: Cleanup source files
      env:
        TASK_ID: ${{ github.event.inputs.task_id }}
      run: |
        echo "ðŸ§¹ æ¸…ç†æºæ–‡ä»¶ä»¥èŠ‚çœå­˜å‚¨ç©ºé—´..."
        
        # æ¸…ç†æºTSæ–‡ä»¶
        rm -rf tasks/$TASK_ID/segment_*.ts
        rm -f tasks/$TASK_ID/filelist.txt
        
        echo "âœ… æºæ–‡ä»¶æ¸…ç†å®Œæˆ"
        echo "ðŸ’¾ èŠ‚çœå­˜å‚¨ç©ºé—´: $(du -sh tasks/$TASK_ID | cut -f1)"
    
    - name: Setup cleanup reminder
      env:
        TASK_ID: ${{ github.event.inputs.task_id }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "â° è®¾ç½®æ¸…ç†æé†’..."
        echo "ðŸ“ Release $TASK_ID å·²åˆ›å»º"
        echo "â³ è¯·åœ¨24å°æ—¶å†…ä¸‹è½½æ–‡ä»¶"
        echo "ðŸ—‘ï¸  è¿‡æœŸæ–‡ä»¶å°†è‡ªåŠ¨æ¸…ç†"
        
        # è¿™é‡Œå¯ä»¥é›†æˆGitHub APIæ¥è®¾ç½®å®šæ—¶æ¸…ç†
        # æˆ–è€…ä½¿ç”¨å¤–éƒ¨æœåŠ¡å¦‚cron-job.org
        echo "ðŸ’¡ å»ºè®®: é…ç½®è‡ªåŠ¨æ¸…ç†è„šæœ¬å®šæœŸæ¸…ç†è¿‡æœŸRelease"
